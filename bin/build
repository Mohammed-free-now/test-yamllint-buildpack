#!/usr/bin/env bash
set -eo pipefail

echo "---> yamllint Buildpack"

# GET ARGS
layersdir=$1

# GET VAR
buildpackdir=$(dirname "$(readlink -f "${BASH_SOURCE%/*}")")

# CREATE THE LAYER DIRECTORY
pythonlayer="$layersdir"/python
mkdir -p "$pythonlayer"

# DOWNLOAD PYTHON
echo "---> Downloading and extracting Python"
python_url=https://s3-external-1.amazonaws.com/heroku-buildpack-python/heroku-20/runtimes/python-3.10.0.tar.gz
wget -q -O - "$python_url" | tar -xzf - -C "$pythonlayer"

# MAKE PYTHON AVAILABLE TO THIS SCRIPT
export PATH="$pythonlayer"/bin:$PATH
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH:+${LD_LIBRARY_PATH}:}"$pythonlayer/lib"

# INSTALL PIP
echo "---> Installing pip"
python -m ensurepip --upgrade

# INSTALL YAMLLINT
echo "---> Installing yamllint"
pip3 install yamllint

# RUN YAMLLINT
echo "---> Validating yaml/yml files"
yamllint -c "$buildpackdir/config/yamllint-config" .

echo "---> [success] Yaml/yaml validation"
